<html>
<head>
	<title>TetradGraphViewer</title>
	<script src="javascript/lib/cytoscape.min.js"></script>
	<script src="javascript/lib/jquery-1.7.1.min.js"></script>
	<style>
  html {
    width : 100%;
    height:100%;
  }
	body {
	  //font-family: helvetica;
    font: verdana;
	  font-size: 14px;
    min-width:950px;
    min-height: 450px;
	}

	#cy {
	  //min-width: 950px;
	  //min-height: 450px;
    //max-width: 2000px;
    //max-height:1000px;
    width: 100%;
    height: 100%;
	  position: absolute;
	  left: 0;
	  top: 0;
	  z-index: 999;
	}

  #edgeInfoOption {
    color : rgb(6,69,173);
    max-width : 100px;
    position:absolute;
    z-index:1000;
    text-decoration: underline;
    font-size:90%;
  }

  #edgeInfo {
    position:absolute;
    top:60px;
    left:20px;
    z-index:1001;
    opacity:1;
    background:white
  }
	h1 {
	  opacity : 0.5;
	  font-size : 1em;
	}
	</style>
</head>

<body>
<div id="graphData" style="visibility:hidden">
${PutGraphDataHere}
</div>

<div id="cy" ></div>

<script>
$(document).ready(function(){

//$("body").width($(document).parent().parent().parent().width());

$("#edgeInfo").hide();
displayEdgeInfo();

var nodes = [];
var childNodes = [];
var edges = [];

var rawData = $("#graphData").text();
var lines = rawData.split('\n');

var i = 0;

var gettingNodesLine = false;
var isSEM = false;
for( ; i < lines.length; i++ )
{
	var l = lines[i];
	
	if( l.includes("Graph Nodes") ){
		gettingNodesLine = true;
    if (l.includes("SEM")) {
      isSEM = true;
    }
		continue;
	}
	if( gettingNodesLine ){
    if (isSEM) {
      var temp = l.split(',');
      console.log(temp);
      //nodes = [];
      for (var j = 0; j < temp.length; j++) {
        var tempToks = temp[j].split(" ");
        console.log(tempToks);
        nodes.push(tempToks[0]);
        childNodes.push(tempToks[0] + tempToks[1]);
      }
    } else {
		  nodes = l.split(',');
    }
		gettingNodesLine = false;
		break;
	}
  console.log(childNodes);
  console.log(nodes);
}

var gettingEdges = false;
var e  = [];

for( ; i < lines.length; i++ )
{
	var l = lines[i];
	
	if( l.includes("Graph Edges") ){
		gettingEdges = true;
    if (l.includes("SEM")) {
      isSEM = true;
    }
		continue;
	}
	if (gettingEdges) {
		var tokens = l.split(/\s+/);
		
		if( tokens.length < 4 ){
      gettingEdges = false;
      continue;
    }
				
		var d = {};
		d.data = {};
		
		var directed = false;

    d.data.source = tokens[1];
    d.data.target = tokens[3];
    d.label = "Hello";

    if (tokens[2] == "---"){      
      d.classes = "undirected";
    } else if(tokens[2] == "<->"){
      d.classes = "bidirected";
    } else if (tokens[2] == '-->') {
      
    } else if (tokens[2] == '<--') {
      d.data.target = tokens[1];
      d.data.source = tokens[3];
    } else if (tokens[2] == 'o->') {
      d.classes = "partiallyOriented";
    } else if (tokens[2] == 'o-o') {
      d.classes = "nondirected";
    }

    for (var j = 4; j < tokens.length; j++) {
      if (tokens[j] == 'nl') {
        d.classes += ' noLatent';
      } else if (tokens[j] == 'dd') {
        d.classes += ' definitelyDirected';
      } else if (!isNaN(tokens[j])) {
        d.data.label = tokens[j].substring(0,6);
      }
    }
		e.push( d )
	}
}

var cytContainer = {
  container: document.getElementById('cy'),

  boxSelectionEnabled: false,
  autounselectify: true,

  layout: {
	//name:'grid|random'
    name: 'circle',//'cose',
    spacingFactor: .45,
	  directed: true,
    sort: 'function(a, b){ return a.data.id.localeCompare(b.data.id); }'
  },

    
  style: cytoscape.stylesheet()
    .selector('node')
      .css({
        'compound-sizing-wrt-labels' : 'exclude',
        'content': 'data(id)',
		    'text-opacity': 1,
        'text-valign': 'center',
        'text-halign': 'center',
        'text-outline-width':2,
        'text-outline-color':'lightblue',
        'font-family': 'verdana',
        'background-color': 'lightblue',
        'opacity' : 1,

        "width": "mapData(idNumChars, 1, 20, 100, 600)",//"label",
        "height": '50%',
        //"padding": '20px',

        'font-size':'40%',
        'color':'black',
        'shape':'roundrectangle',

        'border-width':1,
        'border-style':'solid',
        'border-color':'black',
        'border-opacity':1
      })
    .selector('node.SEM_Label')
      .css({
        'content': 'data(name)',
        'text-opacity': 1,
        'text-valign': 'bottom',
        'text-halign': 'right',
        'text-outline-width':5,
        'text-outline-color':'white',
        'font-size' : '28%',
        'background-opacity' : 0,
        'border-opacity' : 0,

        'color':'rgb(0, 180, 0)',

      })
    .selector('edge')
      .css({
        'content' : 'data(label)',
        'text-outline-width':5,
        'text-outline-color':'white',
        'font-family': 'verdana',
        'curve-style': 'bezier',
        'target-arrow-shape': 'triangle',
        'width': 3,
        'line-color': 'rgb(82, 120, 177)',
        'target-arrow-color': 'rgb(82, 120, 177)',
        'source-arrow-color': 'rgb(82, 120, 177)',
        'arrow-scale': 3,
        'font-size' : '25%'
      })
     .selector('edge.undirected')
      .css({
        'target-arrow-shape': 'none'
      })
     .selector('edge.bidirected')
      .css({
        'target-arrow-shape': 'triangle',
        'source-arrow-shape': 'triangle'
      })
    .selector('edge.partiallyOriented')
      .css({
        'target-arrow-shape': 'triangle',
        'source-arrow-shape': 'circle',
        'source-arrow-fill':'hollow'
      })
    .selector('edge.nondirected')
      .css({
        'target-arrow-shape': 'circle',
        'source-arrow-shape': 'circle',
        'target-arrow-fill':'hollow',
        'source-arrow-fill':'hollow'
      })
    .selector('edge.definitelyDirected')
      .css({
        'line-color': 'rgb(0, 255, 0)',
        'target-arrow-color': 'rgb(0, 255, 0)'
      })
    .selector('edge.noLatent')
      .css({
        'line-style': 'dashed'
      })
    .selector('.highlighted')
      .css({
        'background-color': '#61bffc',
        'line-color': '#61bffc',
        'target-arrow-color': '#61bffc',
        'transition-property': 'background-color, line-color, target-arrow-color',
        'transition-duration': '0.5s'
      }),

	
  elements: {
  },
}

//add nodes to the container
cytContainer.elements.nodes = [];
///if (!isSEM) {
  for( var j = 0; j < nodes.length; j++ ){
  	var d = {};
  	d.data = {};
  	d.data.id = nodes[j];
    d.data.idNumChars = nodes[j].length;
  	cytContainer.elements.nodes.push(d);
  }
//}
if (isSEM) {
  for( var j = 0; j < childNodes.length; j++) {
    var d = {};
    d.data = {};
    //d.data.id = childNodes[j].replace(nodes[j],"").substring(0,6);
    d.data.id = childNodes[j];
    d.data.name = childNodes[j].replace(nodes[j],"").substring(0,6);
    d.classes = "SEM_Label";
    d.data.parent = nodes[j];
    d.data.idNumChars = nodes[j].length;
    cytContainer.elements.nodes.push(d);
  }
}
console.log(cytContainer.elements.nodes);

//add edges to the container
cytContainer.elements.edges = e;

//Create the graph
var cy = window.cy = cytoscape(cytContainer);


window.parent.document.getElementsByClassName('visFrame').width = '700px';
window.parent.document.getElementsByClassName('visFrame').height = '500px';
});

function displayEdgeInfo() {
  $("body").prepend(
      '<div id="edgeInfoOption">' + 
      'Click for more (or less) info about graph edge types</div>');
 
  $("#edgeInfoOption").on("click", function() {
    $("#edgeInfo").toggle();
  });
  $("#edgeInfo").on("click", function() {
    $("#edgeInfo").toggle();
  })
}


</script>

</body>

<div id="edgeInfo" >
<table width="95%" border="1" bgcolor="maroon">
    <tbody>
    <tr>
        <td>
            <h2><font color="white">Graph Edge Types</font></h2>
        </td>
    </tr>
    </tbody>
</table>

<table width="95%" border="1">
    <thead>
        <tr>
            <th>Edge Types</th>
            <th>Present Relationships</th>
            <th>Absent Relationships</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>A --&gt; B</td>
            <td>
                A is a cause of B.<br />
                It may be a direct or indirect cause that may include other measured variables. Also, there may be an unmeasured confounder of A and B.
            </td>
            <td>B is not a cause of A</td>
        </tr>
        <tr>
            <td>A &lt;-&gt; B</td>
            <td>There is an unmeasured confounder (call it L) of A and B. There may be measured variables along the causal pathway from L to A or from L to B.</td>
            <td>
                A is not a cause of B.<br />
                B is not a cause of A.
            </td>
        </tr>
        <tr>
            <td>A o-&gt; B</td>
            <td>Either A is a cause of B (i.e, A --&gt; B) or there is an unmeasured confounder of A and B (i.e, A &lt;-&gt; B) or both.</td>
            <td>B is not a cause of A.</td>
        </tr>
        <tr>
            <td>A o-o B</td>
            <td>
                Exactly one of the following holds:
                <ol>
                    <li>A is a cause of B</li>
                    <li>B is a cause of A</li>
                    <li>there is an unmeasured confounder of A and B</li>
                    <li>both a and c</li>
                    <li>both b and c</li>
                </ol>
            </td>
            <td></td>
        </tr>
    </tbody>
    <tfoot>
        <tr>
            <td colspan="3">If an edge is dashed that means there is no latent confounder. Otherwise, there is possibly latent confounder.</td>
        </tr>
        <tr>
            <td colspan="3">If an edge is green that means it is definitely direct. Otherwise, it is possibly direct.</td>
        </tr>
    </tfoot>
</table>

</div>

</html>